
trigger:
  - main

resources:
  - repo: self

variables:
  dockerRegistryServiceConnection: "70193de8-17c3-4d45-aed9-7b6d459cb210"
  imageRepository: "martinsutherlandazurepipelinedemo"
  containerRegistry: "customersapp.azurecr.io"
  dockerfilePath: "$(Build.SourcesDirectory)/Dockerfile"
  tag: "$(Build.BuildId)"
  appName: "Azure-test-App-Two"
  azureSubscription: "Azure subscription 1 (12d4a125-7d4d-45ad-8101-2ba4e5ce1593)"
  vmImageName: "ubuntu-latest"
  uiSource: "/src"

stages:
- stage: Build
  displayName: 'Build Docker Image'
  jobs:
  - job: Build
    displayName: Build
    pool:
          vmImage: $(vmImageName)

    steps:
    - task: Docker@2
      inputs:
        command: build
        repository: $(imageRepository)
        dockerfile: $(dockerfilePath)
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
                $(tag)

- stage: Test
  displayName: 'Test Dockerized App'
  jobs:
  - job: Test
    steps:
    - task: Docker@2
      inputs:
        containerRegistry: $(dockerRegistryServiceConnection)
        repository: $(imageRepository)
        command: 'run'
        arguments: '-d -p 3000:3000 --name ms-container $(imageRepository)'
        
- job: RunPlaywrightTests
  steps:
  - script: |
      docker exec ms-container npx playwright test
    displayName: 'Run Playwright Tests'

- job: StopContainer
  steps:
  - script: |
      docker stop ms-container
      docker rm ms-container
    displayName: 'Stop and Remove Container'